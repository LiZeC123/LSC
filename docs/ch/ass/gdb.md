使用gdb调试汇编程序
==================

由于各种因素, 通过编译器生成的汇编代码难免会存在一些错误, 这些错误可能并不是语法错误, 因此使用nasm进行汇编后也不能发现这些错误. 直接运行最后的可执行文件又往往只能得到一个段错误的提示. 因此有必要使用调试工具对最后的代码进行相关的调试. 下面介绍GDB调试的一些指令和配置方法.


基本指令
----------


| 命令            | 解释                                           | 示例               |
| --------------- | ---------------------------------------------- | ------------------ |
| `file <文件名>` | 使GDB加载指定的文件                            | (gdb) file a.out   |
| r               | Run, 运行程序                                  | (gdb) r            |
| c               | Continue, 继续运行程序                         | (gdb) c            |
| b               | Break, 添加断点                                | (gdb) b mian       |
| d               | 指定一个数字, 则删除指定断点, 否则删除所有断点 | (gdb) d 1          |
| s, n            | Step, Next, 以c语句为单位                      | (gdb) s            |
| si, ni          | 同上, 但以汇编指令为单位                       | (gdb) si           |
| p               | Print 显示指定的变量的值                       | (gdb) p $eax       |
| dispaly         | 在每次中断后显示指定变量的值                   | (gdb) display $eax |
| i               | 显示有关的信息                                 | (gdb) i r          |
| q               | 退出                                           | (gdb) q            |


详细说明
--------------

#### 添加断点

GDB提供了四种添加断点的方式，分别为

1. `b <行号>`
2. `b <函数名>`
3. `b *<函数名>`
4. `b *<代码地址>`

其中行号指的是C语言源代码的行号, 由于我们使用汇编语言, 因此没有对应的源代码, 不能使用基于行号的断点。对于使用标准汇编器编译的程序，可以使用第2种方法按照函数名设置断点，对于本项目汇编的程序，则只能使用第4种方法，直接在函数地址上设置断点。

#### 逐语句与逐过程

- s表示Step, 执行一个C语句, 如果是函数, 则会进入函数
- n表示Next, 执行一个C语句, 如果是函数, 则执行完函数
- si表示逐语句的执行一条汇编指令
- ni表示逐过程的执行一条汇编指令

### 查看内存区域

使用`x /<n><f><u> <addr>`指令查看一块内存区域的值，其中

- `<n>`是一个正整数，表示要显示的内存单元的数量
- `<f>`表示显示数据的格式，例如以字符串方式显示或者以十六进制显示等
- `<u>`表示每个内存单元的大小

`<f>`参数可用的取值为：

| 参数 | 含义           | 参数 | 含义               |
| ---- | -------------- | ---- | ------------------ |
| x    | 十六进制显示   | u    | 十六进制无符号显示 |
| d    | 十进制显示     | o    | 八进制显示         |
| t    | 二进制显示     | a    | 十六进制显示       |
| c    | 字符串格式显示 | f    | 浮点格式显示       |

`<u>`参数可用的取值为：

| 参数 | 含义   | 参数 | 含义   |
| ---- | ------ | ---- | ------ |
| b    | 单字节 | h    | 双字节 |
| w    | 四字节 | g    | 八字节 |

----------------




#### display指令

- 使用display指令, 相当于添加了一个监视变量每次遇到断点或者使用了s或n以后, 会打印指定的变量的值
- 使用`display /i $pc`可以打印下一条汇编指令
- 使用`undisplay <编号>` 可以取消指定序号的打印操作

#### 显示所有寄存器的值

- 使用`i r`指令

#### 显示变量值

p指令可以显示一个C语言中定义的全局或局部变量的值


使用初始化脚本
--------------

如果一个程序存在某些问题需要反复的调试,  则有些初始化的命令可能需要反复的被执行, 此时可以使用gdb脚本来减少工作量.


#### 1. 创建脚本
- 在需要调试的文件的目录下创建`.gdbinit`文件, gdb启动时会自动加载当前目录下的此文件

#### 2. 配置脚本

脚本中可以编写任意的gdb指令, 以下是示例:

```
set disassembly-flavor intel
file a.out
display /x $eax
display /x $ebx
display /x $ecx
display /x $edx
display /i $pc
b *0x8048080
r
```

上述脚本启动了当前目录下的a.out文件, 将反汇编格式设为intel格式, 要求每次断点时显示eax, ebx, ecx, edx的值以及下一条指令的值. 然后在整个文件的入口位置设置了一个断点。

#### 启用脚本

由于安全原因, gdb默认不加载`.gdbinit`文件, 如果直接启动gdb会给出相关的警告, 同时提示可以设置允许启动的路径. 因此按照要求, 可以执行以下步骤来启用脚本

1. 在用户文件夹下创建`.gdbinit`文件
2. 在其中加入`set auto-load safe-path /`

如果不嫌麻烦, 也可以把上述指令中的`/` 换成具体的目录名.